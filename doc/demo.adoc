# Прототип работы с Single Sign-On (SSO) системой по OpenID Connect протоколу.

## Описание прототипа

Данный прототип призван рассмотреть пользовательские
случаи взаимодействия микросервисной архитектуры с системой управления
аутентификацией и доступом SSO - **Keycloak** (см. http://www.keycloak.org) и
**CAS Enterprise Single Sign-On (CAS)** (https://github.com/apereo/cas).

Рассмотрены следующие пользовательские случаи (см. link:demo-work-flow.puml[demo-work-flow.puml]):

1) Фронтенд приложение (`frontend-registration`) имеет доступ к специализированным ресурсам Бэкенда (`backend`).
Данный случай реализован припиской особого пользователя для Фронтенда, через которого приложение ходит в Бэкенд.

2) Созданные новые пользователи на Бэкенде поддерживаются системой SSO/CAS.

3) Другое фронтенд приложение отличное от первого (`frontend-accounting`) предоставляет форму авторизации
для пользователей с доступом к ресурсам Бэкенда (`backend`).

## Раскрытые в прототипе возможности SSO систем

Следующие возможности представлены для обеих систем **Keycloak** и **CAS**:

* Авторизация пользователей из локальной БД на примере `PostgreSQL`.
* Авторизация через поддерживаемые социальные сети на примере `Google+`.
* Подключение дополнительного провайдера авторизации на примере социальной сети `Вконтакте`.
* Двухфазовая авторизация на примере `Google Authenticator`.

## Описание особеностей работы с системой Keycloak

### Рабочий процесс

Сервер Keycloak предоставляется как `standalone` на среде `JBoss WildFly` с поддержкой через расширения
таких сред как `JBoss EAP/AS/Fuse/WildFly`, `Tomcat` и `Jetty`.
Есть поддержка `Docker` образа.

Конфигурация сервера обеспечивается через графический интерфейс терминала администратора.

Keycloak расширяем предоставляя `Service Provider Interface (SPI)` для всех аспектов своего поведения.

### Источники пользователей

Keycloak поддерживает из коробки два источника пользователей (`User Federation`) это `LDAP` и `Kerberos`,
для иных источников (например БД) Keycloak предоставляет `Service Provider Interface (SPI)`.
Экземпляр такого провайдера для БД представлен в прототипе (см. `user-storage-jpa-example`)

### Авторизация через социальные сети

Для подключения авторизации через поддерживаемые социальные сети
см. Social Identity Providers - http://www.keycloak.org/docs/2.5/server_admin/topics/identity-broker/social-login.html.

### Двухфазовая авторизация

На текущий момент Keycloak поддерживает двухфазовую авторизацию только для `FreeOTP` и `Google Authenticator`.

По умолчанию политика Keycloak предоставляет пользователям возможность самим установить для себя двухфазовую авторизацию.
Для этого перейдите на стандартный для Keycloak клиент `account` по пути `/auth/realms/realm_name/account`.
Выберите вкладку `Authenticator` и следуйте далее представленной инструкции.

### Поддержка технологий клиентских приложений

Сообщество Keycloak предоставляет проект быстрого старта (см. keycloak-quickstarts - https://github.com/keycloak/keycloak-quickstarts).
В этом проекте представлен Keycloak Spring Boot Starter, библиотека для работы с Keycloak по OpenID Connect протоколу на JavaScript
с адаптацией под TypeScript, пример использования Keycloak SPI для подключения БД в качестве `User Federation`.

## Описание особеностей работы с системой CAS Enterprise Single Sign-On

### Рабочий процесс

Сервер CAS распространяется по методологии `War Overlay` для `Maven` и `Gradle` сред с поддержкой `Tomcat`, `Jetty`
и многих других контейнеров. Также сообществом CAS распространяется Spring Boot Admin (см. https://codecentric.github.io/spring-boot-admin/1.5.0/)
расширение для мониторинга сервера CAS.
Есть поддержка `Docker` образа.

### Стабильность

Обратите внимания, что в прототипе используется 5.3.0-RC2-SNAPSHOT версия CAS сервера, поэтому возможна не стабильная работа.
Использование данной не стабильной версии необходимо по причине исправления критического бага в OpenID Connect протоколе в последней релизной версии 5.2.2.

Использование RC версии не обошлось без проблем. Работающий функционал двухфакторной авторизации через `Google Authenticator`
в релизной версии 5.2.2, отвалился в RC версии c исключением.

Также надо отметить, что обновление версии включало в себя исправления имён свойств CAS сервера,
но было благополучно решено благодаря верификации свойств при сборке.

### Поддержка OpenID Connect протокола

В сообществе CAS не представлена поддержка OpenID Connect протокола для Spring системы
в отличии от Keycloak, где предоставляется Spring Boot Starter с поддержкой Spring Security.
В данном прототипе Бэкенда основан на технологии Spring Boot 1.5.9, поддержка же OpenID Connect протокола
в Spring Security начата со Spring 5 (Spring Boot 2.x) версии.
Поэтому пример работы Бэкенда с CAS реализован используя Spring Security OAuth 2.0 SSO поддержку.
